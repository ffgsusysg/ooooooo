<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>منصة إديسون</title>

  <!-- Open Graph -->
  <meta property="og:title" content="منصة إديسون التعليمية" />
  <meta property="og:description" content="منصة اديسون التعليمية هي منصة تقدم محاضرات لطلاب السادس العلمي بشكل مجاني 2026_ 2025" />
  <meta property="og:image" content="https://i.imghippo.com/files/Baa5419rPk.jpg" />
  <meta property="og:url" content="https://adson.netlify.app" />
  <meta property="og:type" content="website" />
  <meta property="og:locale" content="ar_AR" />

  <!-- Icons & PWA -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="https://cdn.glitch.global/c07dc79d-c056-48b0-8b0b-912783754321/5424770778815132543.jpg?v=1751739020203">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Almarai:wght@400;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">

  <!-- Player & Icons -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="preconnect" href="https://iframe.mediadelivery.net" crossorigin />
  <script src="https://assets.mediadelivery.net/hls/1.6.6/hls.min.js"></script>
  <script src="https://assets.mediadelivery.net/plyr/3.7.8.4-bn/plyr.polyfilled.min.js"></script>

  <!-- ====== Styles ====== -->
  <style>
    :root {
      --primary-1:#3b82f6; --primary-2:#2563eb; --primary-3:#1d4ed8; --accent:#facc15; --accent-2:#eab308;
      --radius:14px; --bg:#f0f4f8; --bg-glass:rgba(255,255,255,.65); --text:#1f2937; --card:rgba(255,255,255,.75);
      --border:#e2e8f0; --hover:rgba(0,0,0,.06); --success:#22c55e; --warning:#facc15; --error:#ef4444;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05); --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --main-bg-grad-1:#e0f2fe; --main-bg-grad-2:#f0f9ff;
    }
    [data-theme="dark"]{
      --bg:#0f172a; --bg-glass:rgba(15,23,42,.85); --text:#e2e8f0; --card:rgba(30,41,59,.7); --border:#334155; --hover:rgba(255,255,255,.06);
      --primary-1:#60a5fa; --primary-2:#3b82f6; --primary-3:#2563eb; --accent:#fcd34d; --accent-2:#fbbf24;
      --main-bg-grad-1:#0b1222; --main-bg-grad-2:#0f172a;
    }
    *,*:before,*:after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{font-family:'Almarai','Tajawal',sans-serif;background:linear-gradient(180deg,var(--main-bg-grad-1),var(--main-bg-grad-2));color:var(--text);line-height:1.6;min-height:100vh;overflow-y:auto;transition:background .3s,color .3s;-webkit-font-smoothing:antialiased}
    .card-glass{background:var(--card);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid rgba(255,255,255,.2)}
    header{position:sticky;top:0;z-index:1000;display:flex;align-items:center;gap:1rem;padding:1rem 1.6rem;background:var(--bg-glass);backdrop-filter:blur(14px);border-bottom:1px solid var(--border);box-shadow:var(--shadow-md);flex-wrap:wrap}
    .site-title{font-size:clamp(1.5rem,5vw,2rem);font-weight:700;color:var(--primary-1);display:flex;align-items:center;gap:.5rem;flex:1;min-width:200px;cursor:pointer}
    .site-logo{width:40px;height:40px;background:var(--primary-1);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;box-shadow:var(--shadow-sm)}
    .header-actions{display:flex;align-items:center;gap:.8rem;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.45rem;padding:.9rem 1.35rem;border-radius:var(--radius);background:var(--primary-1);color:#fff;font-weight:700;transition:all .25s;white-space:nowrap;box-shadow:var(--shadow-sm)}
    .btn:hover{opacity:.95;transform:translateY(-2px);box-shadow:var(--shadow-md)}
    .btn-outline{background:transparent;border:2px solid var(--primary-1);color:var(--primary-1)}
    .btn-outline:hover{background:var(--primary-1);color:#fff}
    .btn-icon{padding:.75rem;border-radius:50%;width:44px;height:44px}
    #dashboardButton.btn-icon{padding:2px;overflow:hidden;border:2px solid var(--primary-2);background-color:var(--card);width:52px;height:52px}
    #headerProfilePic{width:100%;height:100%;object-fit:cover;border-radius:50%}
    .search-container{flex:1;max-width:650px;display:flex;gap:.5rem;position:relative;min-width:250px;margin-top:.5rem}
    .search-container input{flex:1;padding:.95rem 1rem .95rem 3rem;background:var(--card);color:var(--text);border:2px solid var(--border);border-radius:var(--radius);transition:border .25s,box-shadow .25s}
    .search-container input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(250,204,21,.25)}
    .search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--primary-1)}

    .page{display:none;padding:2rem;max-width:1300px;margin:0 auto;animation:fadeIn .5s}
    .page.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

    .categories-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.8rem;margin-top:1.2rem}
    .category-card{border:none;padding:1.5rem;display:flex;flex-direction:column;justify-content:space-between;min-height:240px;position:relative;overflow:hidden;color:#fff;box-shadow:var(--shadow-lg);cursor:pointer}
    .category-card::before{content:"";position:absolute;inset:0;background-image:var(--gradient);transition:transform .4s}
    .category-card:hover::before{transform:scale(1.05)}
    .category-icon,.category-content{position:relative;z-index:2}
    .category-content{padding:0;background:linear-gradient(to top,rgba(0,0,0,.5),transparent);margin:-1.5rem;padding:3rem 1.5rem 1.5rem}
    .category-title{color:#fff;font-size:1.8rem;text-shadow:1px 1px 4px rgba(0,0,0,.4)}

    .teachers-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1.6rem;margin-top:1rem}
    .teacher-card{background:var(--card);backdrop-filter:blur(15px);border:1px solid var(--border);padding:1.2rem;border-radius:var(--radius);text-align:center;position:relative;overflow:hidden;box-shadow:var(--shadow-sm);cursor:pointer}
    .teacher-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-lg)}
    .teacher-img{width:120px;height:120px;border-radius:50%;object-fit:cover;margin:0 auto 1rem;border:3px solid var(--accent)}
    .teacher-name{font-size:1.2rem;font-weight:800;color:var(--primary-1)}
    .teacher-subject{opacity:.8}
    .teacher-rating{display:flex;justify-content:center;gap:.2rem;margin:.4rem 0}
    .teacher-rating .star{color:#ddd;font-size:1.1rem}
    .teacher-rating .star.filled{color:var(--warning)}
    .favorite-button-container{position:absolute;top:10px;right:10px;z-index:5}
    .btn-favorite{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--card);border:1px solid var(--border);color:var(--border)}
    .btn-favorite.active{background:#ff5252;color:#fff;border-color:#ff5252}

    .teacher-info{display:flex;align-items:center;gap:1.2rem;background:var(--card);padding:1.2rem;border-radius:var(--radius);border:1px solid var(--border);flex-wrap:wrap;margin-bottom:1rem}
    .teacher-img-lg{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--accent)}

    .classes-list{display:grid;gap:1rem}
    .class-card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden}
    .class-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.2rem;cursor:pointer;background:var(--bg-glass);border-right:4px solid var(--primary-2)}
    .lectures-list{display:none;flex-direction:column;gap:.7rem;padding:1rem 1.2rem}
    .lecture-item{position:relative;background:var(--hover);border-right:3px solid var(--primary-3);border-radius:6px;display:flex;justify-content:space-between;align-items:center;padding:.85rem 1rem}
    .lecture-item.completed{background:#dcfce7;border-right-color:var(--success)}
    [data-theme="dark"] .lecture-item.completed{background:#164e3b}
    .lecture-play-area{display:flex;align-items:center;gap:.6rem;flex:1}

    .completion-checkbox{position:relative;width:24px;height:24px;cursor:pointer;margin-left:.8rem}
    .completion-checkbox input{opacity:0;width:0;height:0}
    .checkmark{position:absolute;inset:0;background:var(--bg);border:2px solid var(--border);border-radius:6px}
    .completion-checkbox input:checked ~ .checkmark{background:var(--success);border-color:var(--success)}
    .checkmark:after{content:"";position:absolute;display:none;left:7px;top:3px;width:6px;height:12px;border:solid #fff;border-width:0 3px 3px 0;transform:rotate(45deg)}
    .completion-checkbox input:checked ~ .checkmark:after{display:block}

    .video-page{display:flex;flex-direction:column;gap:1.2rem;max-width:1000px;width:100%;margin:0 auto}
    .video-container{position:relative;width:100%;background:#000;border-radius:var(--radius);overflow:hidden;aspect-ratio:16/9;box-shadow:var(--shadow-lg)}
    .plyr{border-radius:var(--radius);overflow:hidden;width:100%;height:100%}
    .video-details{background:var(--card);padding:1.2rem;border-radius:var(--radius);border:1px solid var(--border);text-align:center}
    .video-meta{display:flex;justify-content:center;gap:1rem;margin-top:.6rem;opacity:.85;flex-wrap:wrap}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:2000;opacity:0;visibility:hidden;transition:opacity .3s,visibility .3s}
    .modal.show{opacity:1;visibility:visible}
    .modal-content{background:linear-gradient(135deg,#6a11cb,#2575fc);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow-lg);max-width:540px;width:92%;text-align:center;border:1px solid rgba(255,255,255,.2)}

    #continueWatchingToast{position:fixed;bottom:20px;right:20px;z-index:2000;max-width:380px;width:90%;background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow-lg);border:1px solid var(--border);opacity:0;visibility:hidden;transform:translateX(120%);transition:all .4s}
    #continueWatchingToast.show{opacity:1;visibility:visible;transform:translateX(0)}

    .section-title{display:flex;align-items:center;gap:.5rem;margin:1.2rem 0 1rem;padding-bottom:.4rem;border-bottom:2px solid var(--primary-1);color:var(--primary-1)}

    /* Announcements */
    .announce{display:none;background:linear-gradient(90deg, #22c55e, #16a34a);color:#fff;padding:.75rem 1rem;text-align:center}
    .announce.show{display:block}

    /* Responsive */
    @media (max-width:768px){
      header{gap:.7rem;padding:.9rem 1rem}
      .search-container{order:3;width:100%}
      .btn{padding:.8rem 1rem}
      .video-page{max-width:none}
      .video-container{border-radius:0;box-shadow:none}
    }
  </style>
</head>
<body>
  <div id="topBar" class="announce">🎉 تحديث جديد: تم تحسين الأداء وإضافة ميزات التقدم والمفضّلة والإكمال! </div>

  <header>
    <h1 class="site-title" onclick="navigate('home')">
      <div class="site-logo">إ</div>
      منصة إديسون
    </h1>

    <div class="header-actions">
      <button id="dashboardButton" class="btn btn-icon" onclick="navigate('dashboard')">
        <img id="headerProfilePic" src="https://placehold.co/42x42/E2E8F0/A0AEC0?text=%20" alt="صورة الملف الشخصي" style="display:none">
        <i data-lucide="user" id="defaultUserIcon"></i>
      </button>
      <button id="themeToggle" class="btn btn-icon" title="تبديل النمط (L)">
        <i data-lucide="moon"></i>
      </button>
      <!-- تم حذف زر الامتحانات بالكامل بناءً على طلبك -->
    </div>

    <div class="search-container">
      <i class="search-icon" data-lucide="search"></i>
      <input id="searchInput" type="text" placeholder="ابحث عن مدرس… ( / )" />
      <button id="searchButton" class="btn btn-icon" title="بحث (Enter)">
        <i data-lucide="search"></i>
      </button>
    </div>
  </header>

  <!-- Modal Telegram -->
  <div id="telegramModal" class="modal">
    <div class="modal-content">
      <h3 style="color:#fff;display:flex;gap:.6rem;justify-content:center;align-items:center"><i data-lucide="bell"></i> مرحبًا في منصة إديسون!</h3>
      <p style="color:#fff;opacity:.95;margin:1rem 0 1.5rem">لا تنسَ الاشتراك في قناتنا على تليجرام لتصلك التحديثات.</p>
      <a href="https://t.me/od7cc" target="_blank" class="btn" style="background:linear-gradient(45deg,#00c6ff,#0072ff);margin-bottom:1rem"><i data-lucide="send"></i> اشترك الآن</a>
      <button id="continueWithoutSubscribingBtn" class="btn btn-outline" style="border-color:#fff;color:#fff">اشتركت سابقًا – المتابعة</button>
    </div>
  </div>

  <!-- Continue Watching Toast -->
  <div id="continueWatchingToast" class="toast card-glass">
    <div class="toast-content" style="flex:1">
      <h3 style="color:var(--primary-1);font-weight:800">تذكير: متابعة المحاضرة</h3>
      <p style="margin:.2rem 0">لقد كنت تشاهد الأستاذ <span id="lastWatchedTeacherName" style="font-weight:700"></span></p>
      <p style="margin:0">في المحاضرة: <span id="lastWatchedLectureTitle" style="font-weight:700"></span></p>
    </div>
    <div class="toast-buttons" style="display:flex;gap:.5rem">
      <button id="continueNowBtn" class="btn"><i data-lucide="play"></i> متابعة</button>
      <button id="closeToastBtn" class="btn btn-outline"><i data-lucide="x"></i></button>
    </div>
  </div>

  <!-- Pages -->
  <div id="homePage" class="page active">
    <div class="section-title"><i data-lucide="layout-grid"></i><h3>اختر القسم المناسب لك</h3></div>
    <div class="categories-grid">
      <div class="category-card" onclick="loadCategory('year-2026')" style="--gradient:linear-gradient(135deg,#0ea5e9,#1a56db)">
        <div class="category-icon"><i data-lucide="calendar-days" style="width:48px;height:48px"></i></div>
        <div class="category-content"><h3 class="category-title">مدرسين سنة 2026</h3><p>محاضرات ومواد 2026</p><button class="btn">عرض المواد</button></div>
      </div>
      <div class="category-card" onclick="loadCategory('year-2025')" style="--gradient:linear-gradient(135deg,#f59e0b,#f97316)">
        <div class="category-icon"><i data-lucide="calendar-days" style="width:48px;height:48px"></i></div>
        <div class="category-content"><h3 class="category-title">مدرسين سنة 2025</h3><p>محاضرات ومواد 2025</p><button class="btn">عرض المواد</button></div>
      </div>
      <div class="category-card" onclick="loadCategory('distinguished')" style="--gradient:linear-gradient(135deg,#10b981,#047857)">
        <div class="category-icon"><i data-lucide="sparkles" style="width:48px;height:48px"></i></div>
        <div class="category-content"><h3 class="category-title">قسم المتميزين</h3><p>مواد خاصة للمتميزين</p><button class="btn">عرض المواد</button></div>
      </div>
      <div class="category-card" onclick="loadCategory('literary')" style="--gradient:linear-gradient(135deg,#8b5cf6,#7c3aed)">
        <div class="category-icon"><i data-lucide="scroll-text" style="width:48px;height:48px"></i></div>
        <div class="category-content"><h3 class="category-title">القسم الأدبي</h3><p>المواد والمناهج الأدبي</p><button class="btn">عرض المواد</button></div>
      </div>
    </div>
  </div>

  <div id="categoryPage" class="page">
    <button class="btn btn-outline" onclick="navigate('home')"><i data-lucide="arrow-right"></i> رجوع لاختيار قسم جديد</button>
    <div class="section-title" style="margin-top:1rem"><i data-lucide="users"></i><h3 id="categoryTitle">المدرسون</h3></div>

    <div id="favoriteTeachersSection" class="card-glass" style="display:none;margin-bottom:1rem;padding:1rem">
      <div class="section-title" style="margin:0"><i data-lucide="heart"></i><h3>مدرّسيني المفضّلين</h3></div>
      <div id="favoriteTeachersGrid" class="teachers-grid"></div>
    </div>

    <div id="teachersGrid" class="teachers-grid"></div>
  </div>

  <div id="classesPage" class="page">
    <button class="btn btn-outline" onclick="navigate('category')"><i data-lucide="arrow-right"></i> الرجوع للمدرسين</button>
    <div class="teacher-info card-glass">
      <img id="teacherImage" class="teacher-img-lg" alt="صورة المدرس" />
      <div>
        <h2 id="teacherName" style="margin-bottom:.25rem"></h2>
        <p id="teacherSubject" class="teacher-subject"></p>
        <div id="teacherRating" class="teacher-rating" style="margin-top:.3rem"></div>
      </div>
    </div>
    <div class="section-title"><i data-lucide="book-open"></i><h3>الفصول الدراسية</h3></div>
    <div id="classesList" class="classes-list"></div>
  </div>

  <div id="videoPage" class="page">
    <div class="video-page">
      <div id="videoContainer" class="video-container">
        <div id="playerContainer"></div>
        <div id="videoLoader" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center">
          <div class="new-loader" style="display:flex;gap:.5rem">
            <div class="dot" style="width:12px;height:12px;background:#fff;border-radius:50%;animation:fadeInOut 1.4s infinite"></div>
            <div class="dot" style="width:12px;height:12px;background:#fff;border-radius:50%;animation:fadeInOut 1.4s infinite .2s"></div>
            <div class="dot" style="width:12px;height:12px;background:#fff;border-radius:50%;animation:fadeInOut 1.4s infinite .4s"></div>
          </div>
        </div>
      </div>
      <div class="video-details card-glass">
        <h2 id="videoTitle"></h2>
        <p id="videoDescription" style="margin-top:.3rem"></p>
        <div class="video-meta">
          <span><i data-lucide="user"></i> <span id="videoTeacherName"></span></span>
          <span><i data-lucide="book"></i> <span id="videoSubjectName"></span></span>
          <button id="shareButton" class="btn btn-outline" title="مشاركة"><i data-lucide="share"></i> مشاركة</button>
        </div>
        <button class="btn btn-outline" style="margin-top:.8rem" onclick="navigate('classes')"><i data-lucide="arrow-right"></i> العودة للفصول</button>
      </div>
    </div>
  </div>

  <div id="dashboardPage" class="page">
    <div class="card-glass" style="padding:1.2rem;margin-bottom:1rem;text-align:center">
      <h1 style="color:var(--primary-1);font-weight:800">لوحة التحكم</h1>
      <p>خصّص صفحتك وتتبع أهدافك وإعدادات المشاهدة.</p>
    </div>

    <div class="teacher-info card-glass" style="align-items:center">
      <div style="position:relative;cursor:pointer" onclick="document.getElementById('profilePictureInput').click()">
        <img id="profilePicture" src="https://placehold.co/150x150/E2E8F0/A0AEC0?text=صورتك" alt="صورة الطالب" style="width:150px;height:150px;border-radius:50%;object-fit:cover;border:5px solid; border-image: linear-gradient(45deg,#8E2DE2,#4A00E0) 1;"/>
      </div>
      <input type="file" id="profilePictureInput" accept="image/*" style="display:none">
      <div style="flex:1">
        <h2 style="margin-bottom:.4rem">مرحبًا أيها البطل!</h2>
        <p>هذه مساحتك الخاصة لتتبع أهدافك وإنجازاتك.</p>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem">
          <div class="card-glass" style="padding:1rem;border-radius:var(--radius);flex:1;min-width:260px">
            <h3 style="display:flex;align-items:center;gap:.5rem;margin-bottom:.6rem"><i data-lucide="rocket"></i> حلمي هو أن أصبح…</h3>
            <input type="text" id="dreamInput" placeholder="مثلاً: طبيب، مهندس…" style="width:100%;padding:.8rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)">
          </div>
          <div class="card-glass" style="padding:1rem;border-radius:var(--radius);flex:1;min-width:260px">
            <h3 style="display:flex;align-items:center;gap:.5rem;margin-bottom:.6rem"><i data-lucide="target"></i> المعدل المستهدف</h3>
            <input type="text" id="gradeInput" placeholder="مثلاً: 99.5%" style="width:100%;padding:.8rem;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)">
          </div>
        </div>
      </div>
    </div>

    <div class="card-glass" style="padding:1rem;border-radius:var(--radius);margin-top:1rem">
      <h3 class="section-title" style="margin:0"><i data-lucide="settings"></i><span>إعدادات المشاهدة</span></h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:.8rem">
        <label class="card-glass" style="padding:1rem">
          السرعة الافتراضية
          <select id="defaultSpeed" style="margin-top:.4rem;width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--border)">
            <option>0.75</option><option>1</option><option selected>1.25</option><option>1.5</option><option>2</option>
          </select>
        </label>
        <label class="card-glass" style="padding:1rem">
          إظهار تلميح الاستمرار بالمشاهدة
          <select id="showContinueToast" style="margin-top:.4rem;width:100%;padding:.6rem;border-radius:10px;border:1px solid var(--border)">
            <option value="true" selected>مفعل</option>
            <option value="false">معطل</option>
          </select>
        </label>
      </div>
      <button class="btn" id="saveDashboardButton" style="margin-top:1rem"><i data-lucide="save"></i> حفظ التغييرات</button>
    </div>
  </div>

  <!-- Plyr (once) -->
  <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>

  <!-- ====== App Script ====== -->
  <script>
  // ---------- Theme ----------
  function initializeTheme(){
    const stored=localStorage.getItem("theme");
    const preferred=window.matchMedia("(prefers-color-scheme: light)").matches?"light":"dark";
    const theme=stored||preferred;document.documentElement.setAttribute("data-theme",theme);updateThemeIcon(theme)
  }
  function updateThemeIcon(theme){
    document.querySelector("#themeToggle i").setAttribute("data-lucide", theme==="dark"?"sun":"moon");
    lucide.createIcons();
  }
  initializeTheme();
  document.getElementById("themeToggle").addEventListener("click",()=>{
    const cur=document.documentElement.getAttribute("data-theme");
    const next=cur==="dark"?"light":"dark";document.documentElement.setAttribute("data-theme",next);localStorage.setItem("theme",next);updateThemeIcon(next)
  });

  // Shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key==='l' || e.key==='L') document.getElementById('themeToggle').click();
    if(e.key==='/' && document.activeElement!==document.getElementById('searchInput')){ e.preventDefault(); document.getElementById('searchInput').focus(); }
    if(e.key==='Enter' && document.activeElement===document.getElementById('searchInput')) handleSearch();
  });

  // ---------- SPA State ----------
  const pages={home:document.getElementById('homePage'),category:document.getElementById('categoryPage'),classes:document.getElementById('classesPage'),video:document.getElementById('videoPage'),dashboard:document.getElementById('dashboardPage')};
  function navigate(page){
    window.scrollTo({top:0,behavior:'smooth'});
    if(page!=="video"){ cleanupPlayer(); }
    if(page==='dashboard') loadDashboardData();
    Object.values(pages).forEach(p=>p.classList.remove('active'));
    pages[page].classList.add('active');
    lucide.createIcons();
    localStorage.setItem('lastPage', page);
  }

  // Restore last page (optional)
  (function(){ const lp = localStorage.getItem('lastPage'); if(lp && pages[lp]) navigate(lp); })();

  // ---------- Player ----------
  let player=null; let currentTeacher=null; let currentClassIndex=0; let currentLectureIndex=0; let currentLectureLink="";
  let lectureProgress=JSON.parse(localStorage.getItem('lectureProgress')||'{}');
  let completedLectures=JSON.parse(localStorage.getItem('completedLectures')||'{}');
  let ratings=JSON.parse(localStorage.getItem('ratings')||'{}');
  let lastWatched=JSON.parse(localStorage.getItem('lastWatched')||'null');
  let favoriteTeachers=JSON.parse(localStorage.getItem('favoriteTeachers')||'[]');

  const teacherImage=document.getElementById('teacherImage');
  const teacherName=document.getElementById('teacherName');
  const teacherSubject=document.getElementById('teacherSubject');
  const teacherRating=document.getElementById('teacherRating');
  const videoTitle=document.getElementById('videoTitle');
  const videoDescription=document.getElementById('videoDescription');
  const categoryTitle=document.getElementById('categoryTitle');
  const classesList=document.getElementById('classesList');
  const teachersGrid=document.getElementById('teachersGrid');
  const playerContainer=document.getElementById('playerContainer');
  const videoLoader=document.getElementById('videoLoader');
  const favoriteTeachersSection=document.getElementById('favoriteTeachersSection');
  const favoriteTeachersGrid=document.getElementById('favoriteTeachersGrid');

  function cleanupPlayer(){
    if(player){ try{ player.destroy(); }catch{} player=null; }
    if(window.hlsInstance){ try{ window.hlsInstance.destroy(); }catch{} window.hlsInstance=null; }
    if(window.progressInterval){ clearInterval(window.progressInterval); window.progressInterval=null; }
    playerContainer.innerHTML=""; videoLoader.style.display='none';
  }

  // ---------- Data ----------
  const categories={
    "year-2026":{ title:"الصفوف الدراسية 2026", endpoint:"https://adson1.netlify.app/data2.json" },
    "year-2025":{ title:"الصفوف الدراسية 2025", endpoint:"https://adson1.netlify.app/data.json" },
    "distinguished":{ title:"قسم المتميزين", endpoint:"https://adson1.netlify.app/ff.json" },
    "literary":{ title:"القسم الأدبي", endpoint:"https://adson1.netlify.app/mm.json" }
  };

  function loadCategory(categoryId){
    const category=categories[categoryId]; if(!category) return;
    categoryTitle.textContent=category.title;
    loadData(category.endpoint);
    navigate('category');
  }

  function skeletonTeacher(){
    return `<div class="teacher-card"><div style="width:120px;height:120px;background:var(--border);border-radius:50%;margin:0 auto 1rem"></div><div style="height:1.2rem;background:var(--border);border-radius:4px;margin-bottom:.5rem;width:80%;margin-inline:auto"></div><div style="height:1rem;background:var(--border);border-radius:4px;width:60%;margin-inline:auto"></div></div>`
  }

  function loadData(endpoint){
    teachersGrid.innerHTML=Array(6).fill(0).map(skeletonTeacher).join('');
    favoriteTeachersGrid.innerHTML=''; favoriteTeachersSection.style.display='none';
    fetch(endpoint,{ headers:{ "Cache-Control":"no-cache" } })
      .then(r=>{ if(!r.ok) throw new Error('خطأ في التحميل'); return r.json(); })
      .then(data=>{ teachers=data.teachers||[]; renderTeachers(); announce(); })
      .catch(()=>{ teachersGrid.innerHTML=`<div class="card-glass" style="padding:1rem;text-align:center">حدث خطأ في تحميل البيانات. <button class="btn btn-outline" onclick="location.reload()" style="margin-top:.6rem">إعادة المحاولة</button></div>`; });
  }

  // ---------- Render ----------
  function renderStars(rating){ let s=""; for(let i=1;i<=5;i++){ s+=`<span class="star ${i<=rating?"filled":""}">★</span>`;} return s; }
  function toggleFavorite(teacherId){ const i=favoriteTeachers.indexOf(teacherId); if(i>-1) favoriteTeachers.splice(i,1); else favoriteTeachers.push(teacherId); localStorage.setItem('favoriteTeachers', JSON.stringify(favoriteTeachers)); renderTeachers(); }
  window.toggleFavorite=toggleFavorite;

  let teachers=[];
  function renderTeacherCard(t, container){
    const isFav=favoriteTeachers.includes(t.id); const rating=ratings[t.id]||0;
    const card=document.createElement('div'); card.className='teacher-card';
    card.innerHTML=`
      <div class="favorite-button-container">
        <button class="btn-favorite ${isFav?'active':''}" onclick="event.stopPropagation(); toggleFavorite(${t.id});"><i data-lucide="heart"></i></button>
      </div>
      <div class="teacher-card-inner" onclick="showTeacher(${t.id})">
        <img class="teacher-img" loading="lazy" src="${t.image}" alt="${t.name}" onerror="this.onerror=null;this.src='https://placehold.co/120x120/E2E8F0/A0AEC0?text=No+Image';">
        <h3 class="teacher-name">${t.name}</h3>
        <p class="teacher-subject">${t.subject}</p>
        <div class="teacher-rating">${renderStars(rating)}</div>
      </div>`;
    container.appendChild(card);
  }

  function renderTeachers(list=teachers){
    const favData=list.filter(t=>favoriteTeachers.includes(t.id));
    const other=list.filter(t=>!favoriteTeachers.includes(t.id));
    if(favData.length){ favoriteTeachersSection.style.display='block'; favoriteTeachersGrid.innerHTML=''; favData.forEach(t=>renderTeacherCard(t, favoriteTeachersGrid)); } else { favoriteTeachersSection.style.display='none'; }
    teachersGrid.innerHTML=''; (other.length?other:list).forEach(t=>renderTeacherCard(t, teachersGrid));
    if(list.length===0) teachersGrid.innerHTML = `<p style='text-align:center'>لا توجد نتائج مطابقة.</p>`;
    lucide.createIcons();
  }

  window.showTeacher=(id)=>{
    currentTeacher=teachers.find(t=>t.id==id); if(!currentTeacher) return;
    teacherImage.src=currentTeacher.image; teacherImage.onerror=function(){ this.onerror=null; this.src='https://placehold.co/120x120/E2E8F0/A0AEC0?text=No+Image'; };
    teacherName.textContent=currentTeacher.name; teacherSubject.textContent=currentTeacher.subject; teacherRating.innerHTML=renderStars(ratings[currentTeacher.id]||0);
    renderClasses(currentTeacher.classes||[]); navigate('classes');
  }

  function renderClasses(classesData){
    classesList.innerHTML=(classesData||[]).map((cls,ci)=>{
      const total=cls.lectures.length; const done=cls.lectures.filter(lec=>completedLectures[lec.url]).length;
      const lectures=cls.lectures.map((lec,li)=>{
        const isCompleted=!!completedLectures[lec.url];
        const safeTitle=(lec.title||'محاضرة').replace(/"/g,'&quot;');
        const safeDesc=(lec.description||'').replace(/"/g,'&quot;');
        return `<div class="lecture-item ${isCompleted?'completed':''}" data-lecture-url="${lec.url}">
            <div class="lecture-play-area" onclick="playLecture(${ci},${li},'${lec.url}','${safeTitle}','${safeDesc}','${currentTeacher.name}','${currentTeacher.id}')">
              <i data-lucide="play-circle"></i>
              <span>${li+1}. ${safeTitle}</span>
            </div>
            <label class="completion-checkbox"><input type="checkbox" ${isCompleted?'checked':''} onchange="toggleLectureCompletion(event,'${lec.url}',this)"/><span class="checkmark"></span></label>
          </div>`;
      }).join('');
      return `<div class="class-card"><div class="class-header" onclick="toggleLectures(this)"><div><h3>${cls.name}</h3><span class="class-progress" data-class-index="${ci}">المكتمل: ${done} / ${total}</span></div><i data-lucide="chevron-down" class="chevron-icon"></i></div><div class="lectures-list">${lectures}</div></div>`
    }).join('');
    lucide.createIcons();
  }

  window.toggleLectures=(header)=>{
    const list=header.parentElement.querySelector('.lectures-list');
    const icon=header.querySelector('.chevron-icon');
    const open=list.style.display!=="flex"; list.style.display=open?"flex":"none"; icon.setAttribute('data-lucide', open? 'chevron-up':'chevron-down'); lucide.createIcons();
  }

  window.toggleLectureCompletion=(event, url, checkbox)=>{
    event.stopPropagation(); const isCompleted=checkbox.checked; completedLectures[url]=isCompleted; localStorage.setItem('completedLectures', JSON.stringify(completedLectures));
    const item=checkbox.closest('.lecture-item'); item.classList.toggle('completed', isCompleted);
    // update progress
    const card=item.closest('.class-card'); const span=card.querySelector('.class-progress'); const idx=parseInt(span.dataset.classIndex,10);
    const classData=currentTeacher.classes[idx]; const total=classData.lectures.length; const done=classData.lectures.filter(lec=>completedLectures[lec.url]).length; span.textContent=`المكتمل: ${done} / ${total}`;
  }

  function loadIframePlayer(url){
    videoLoader.style.display='flex';
    const encoded=btoa(url);
    const iframeUrl=`https://late-lake-bc53.hweeriew.workers.dev/proxy_iframe?url=${encoded}`;
    const html=`<div style="position:absolute;inset:0"><iframe src="${iframeUrl}" allowfullscreen loading="eager" style="width:100%;height:100%;border:none;border-radius:inherit" referrerpolicy="no-referrer-when-downgrade" allow="autoplay;accelerometer;clipboard-write;encrypted-media;gyroscope;picture-in-picture;fullscreen" onload="document.getElementById('videoLoader').style.display='none'"></iframe></div>`;
    playerContainer.innerHTML=html;
  }

  window.playLecture=(ci, li, url, title, desc, teacherNameParam, teacherIdParam)=>{
    cleanupPlayer();
    [currentClassIndex,currentLectureIndex,currentLectureLink]=[ci,li,url];
    videoTitle.textContent=title; videoDescription.textContent=desc; document.getElementById('videoTeacherName').textContent=teacherNameParam || (currentTeacher?currentTeacher.name:''); document.getElementById('videoSubjectName').textContent=currentTeacher?currentTeacher.subject:'';

    lastWatched={ teacherId:teacherIdParam || (currentTeacher?currentTeacher.id:null), teacherName:teacherNameParam || (currentTeacher?currentTeacher.name:null), classIndex:ci, lectureIndex:li, lectureTitle:title, lectureUrl:url, lectureDescription:desc };
    localStorage.setItem('lastWatched', JSON.stringify(lastWatched));

    navigate('video');

    // Decide playback method
    let finalUrl=url.trim();
    const isMediadeliveryIframe = finalUrl.includes('iframe.mediadelivery.net/embed/');
    if(isMediadeliveryIframe){ loadIframePlayer(finalUrl); return; }

    let isHLS = /\.m3u8(\?|$)/.test(finalUrl);
    // Special case: direct mp4 from your proxy
    const isDirectMp4 = finalUrl.startsWith('https://f2l-bot828-40f1f76157f8.herokuapp.com') && /\.mp4(\?|$)/.test(finalUrl);
    const directPlayDomains=["https://9bf9f797be0a4677a8-akamai-cdn.com","https://vidcdn.akamai-cdn-delivery.com"];
    const referer="https://abwaab.com";
    let useProxy = !(isDirectMp4 || directPlayDomains.some(d=>finalUrl.startsWith(d)));

    // Mediadelivery HLS pattern (vz-<lib>.becdn.net/<video>/playlist.m3u8) if user passed a non-iframe id, you may adapt here if needed

    const proxied = (useProxy && isHLS) ? `https://khdj.hweeriew.workers.dev/?url=${encodeURIComponent(finalUrl)}&referer=${encodeURIComponent(referer)}` : finalUrl;

    playerContainer.innerHTML='<video id="player" playsinline controls></video>';
    lucide.createIcons();
    const videoEl=document.getElementById('player');
    const savedPerc=lectureProgress[url] || 0;
    const defaultSpeed = parseFloat(localStorage.getItem('defaultSpeed') || '1.25');

    player=new Plyr('#player',{ controls:["rewind","play-large","play","fast-forward","progress","current-time","settings","fullscreen"], keyboard:{focused:true,global:true}, tooltips:{controls:true,seek:true}, settings:["quality","speed"], speed:{selected:defaultSpeed,options:[0.5,0.75,1,1.25,1.5,2]} });

    window.progressInterval=setInterval(()=>{
      if(player&&player.duration>0){ const progress=(player.currentTime/player.duration)*100; lectureProgress[url]=progress; localStorage.setItem('lectureProgress', JSON.stringify(lectureProgress)); }
    }, 3000);

    function seekSaved(){ try{ if(savedPerc>0 && player.duration){ player.currentTime = (savedPerc/100)*player.duration; } }catch{}
    }

    if(isHLS && window.Hls && Hls.isSupported()){
      const hls = new Hls(); window.hlsInstance=hls; hls.attachMedia(videoEl); hls.loadSource(proxied);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ player.play().then(seekSaved).catch(()=>{}); });
      hls.on(Hls.Events.ERROR, (_,data)=>{ if(data.fatal){ if(data.type===Hls.ErrorTypes.NETWORK_ERROR) hls.startLoad(); else if(data.type===Hls.ErrorTypes.MEDIA_ERROR) hls.recoverMediaError(); }});
    }else{
      player.source={ type:'video', sources:[{ src:proxied, type: isHLS? 'application/x-mpegURL':'video/mp4' }] };
      player.play().then(seekSaved).catch(()=>{});
    }
  }

  // Share
  document.getElementById('shareButton').addEventListener('click', async ()=>{
    try{
      if(navigator.share){ await navigator.share({ title: document.title, text: videoTitle.textContent, url: location.href }); }
      else{ await navigator.clipboard.writeText(location.href); alert('تم نسخ الرابط إلى الحافظة'); }
    }catch{}
  });

  // ---------- Search ----------
  const searchInput=document.getElementById('searchInput'); const searchBtn=document.getElementById('searchButton');
  function handleSearch(){ const term=searchInput.value.trim().toLowerCase(); renderTeachers(teachers.filter(t=> t.name.toLowerCase().includes(term)|| t.subject.toLowerCase().includes(term))); }
  let searchTimeout; searchInput.addEventListener('input', ()=>{ clearTimeout(searchTimeout); searchTimeout=setTimeout(handleSearch,250); }); searchBtn.addEventListener('click', handleSearch);

  // ---------- Dashboard ----------
  const profilePictureEl=document.getElementById('profilePicture');
  const profilePictureInputEl=document.getElementById('profilePictureInput');
  const dreamInputEl=document.getElementById('dreamInput');
  const gradeInputEl=document.getElementById('gradeInput');
  const saveDashboardButton=document.getElementById('saveDashboardButton');
  const headerProfilePicEl=document.getElementById('headerProfilePic');
  const defaultUserIconEl=document.getElementById('defaultUserIcon');

  function updateHeaderProfilePic(){
    const profile=JSON.parse(localStorage.getItem('userProfile')||'{}');
    if(profile.picture){ headerProfilePicEl.src=profile.picture; headerProfilePicEl.style.display='block'; defaultUserIconEl.style.display='none'; } else { headerProfilePicEl.style.display='none'; defaultUserIconEl.style.display='block'; }
  }
  function loadDashboardData(){
    const profile=JSON.parse(localStorage.getItem('userProfile')||'{}');
    if(profile.picture) profilePictureEl.src=profile.picture; if(profile.dream) dreamInputEl.value=profile.dream; if(profile.grade) gradeInputEl.value=profile.grade;
    const ds = localStorage.getItem('defaultSpeed'); if(ds) document.getElementById('defaultSpeed').value=ds; const toastPref = localStorage.getItem('showContinueToast'); if(toastPref!==null) document.getElementById('showContinueToast').value = toastPref;
    updateHeaderProfilePic();
  }
  profilePictureInputEl.addEventListener('change',(e)=>{ const f=e.target.files[0]; if(f){ const reader=new FileReader(); reader.onload=(ev)=>{ profilePictureEl.src=ev.target.result; }; reader.readAsDataURL(f);} });
  saveDashboardButton.addEventListener('click',()=>{
    const profile={ picture:profilePictureEl.src, dream:dreamInputEl.value, grade:gradeInputEl.value };
    localStorage.setItem('userProfile', JSON.stringify(profile));
    localStorage.setItem('defaultSpeed', document.getElementById('defaultSpeed').value);
    localStorage.setItem('showContinueToast', document.getElementById('showContinueToast').value);
    updateHeaderProfilePic(); saveDashboardButton.innerHTML='<i data-lucide="check"></i> تم الحفظ!'; lucide.createIcons(); setTimeout(()=>{ saveDashboardButton.innerHTML='<i data-lucide="save"></i> حفظ التغييرات'; lucide.createIcons(); },1500);
  });

  // ---------- Modal + Continue Toast ----------
  const telegramModal=document.getElementById('telegramModal');
  const continueWithoutSubscribingBtn=document.getElementById('continueWithoutSubscribingBtn');
  const continueWatchingToast=document.getElementById('continueWatchingToast');
  const lastWatchedTeacherName=document.getElementById('lastWatchedTeacherName');
  const lastWatchedLectureTitle=document.getElementById('lastWatchedLectureTitle');
  const continueNowBtn=document.getElementById('continueNowBtn');
  const closeToastBtn=document.getElementById('closeToastBtn');

  function showTelegramModal(){ const has=localStorage.getItem('telegramSubscribed'); if(!has){ telegramModal.classList.add('show'); lucide.createIcons(); } else { maybeShowContinueToast(); } }
  function hideTelegramModal(){ telegramModal.classList.remove('show'); }
  continueWithoutSubscribingBtn.addEventListener('click',()=>{ localStorage.setItem('telegramSubscribed','true'); hideTelegramModal(); maybeShowContinueToast(); });
  document.querySelector('#telegramModal .btn').addEventListener('click',()=>{ localStorage.setItem('telegramSubscribed','true'); hideTelegramModal(); maybeShowContinueToast(); });

  function maybeShowContinueToast(){
    if(localStorage.getItem('showContinueToast')==='false') return;
    const lw=JSON.parse(localStorage.getItem('lastWatched')||'null'); if(lw){ lastWatchedTeacherName.textContent=lw.teacherName||''; lastWatchedLectureTitle.textContent=lw.lectureTitle||''; continueWatchingToast.classList.add('show'); setTimeout(hideContinueToast,10000); }
  }
  function hideContinueToast(){ continueWatchingToast.classList.remove('show'); }
  closeToastBtn.addEventListener('click', hideContinueToast);
  continueNowBtn.addEventListener('click', ()=>{
    hideContinueToast(); const lw=JSON.parse(localStorage.getItem('lastWatched')||'null'); if(!lw) return;
    const keys=Object.keys(categories); let found=false;
    (async()=>{
      for(const id of keys){ const ep=categories[id].endpoint; try{ const r=await fetch(ep); const d=await r.json(); const t=(d.teachers||[]).find(x=>x.id===lw.teacherId); if(t){ currentTeacher=t; playLecture(lw.classIndex,lw.lectureIndex,lw.lectureUrl,lw.lectureTitle,lw.lectureDescription,lw.teacherName,lw.teacherId); found=true; break; } }catch(e){}
      }
    })();
  });

  // Announce bar auto-hide
  function announce(){ const bar=document.getElementById('topBar'); bar.classList.add('show'); setTimeout(()=>bar.classList.remove('show'), 6000); }

  // ---------- Init ----------
  window.addEventListener('load',()=>{ setTimeout(showTelegramModal, 700); loadDashboardData(); lucide.createIcons(); });

  // ---------- Service Worker (optional offline) ----------
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>{ navigator.serviceWorker.register('/sw.js').catch(()=>{}); });
  }
  </script>
</body>
</html>
